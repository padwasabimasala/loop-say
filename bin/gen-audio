#!/usr/bin/env bash
# https://trac.ffmpeg.org/wiki/Concatenate
set -euo pipefail

WPM="${WPM:=125}"
# Use leading zeros for repeats 1-9
REPEAT="${REPEAT:=30}"
FADE="${FADE:=10}"
BG="${BG:=../var/lofi.m4a}"
VOICE="${VOICE:=Karen}"
#BG=progrock
#$BG=trap
SPACINGMS="${SPACINGMS:=750}"
ARTIST="${ARTIST:=Calvary Bible Memory Club}"
ALBUM_TITLE="${ALBUM:=The Sermon on the Mount - NLT}"
ARTWORK="${ARTWORK:=../var/cover.png}"

tracks=$@
 
mkdir -p out
cd out

for track in $tracks; do
  text=$track
  echo text:$track
  track=${track%.*}
  echo track:$track

  echo "Generating voice text with say"
  say -v ${VOICE} -r $WPM -f ../"$track" -o $track.aiff

  # Add 2s silence to start of the track
  echo "Adding silence to track start"
  ffmpeg -i $track.aiff -af "adelay=${SPACINGMS}ms:all=true" $track.wav
  rm $track.aiff

  echo generating repeat
  for i in $(seq -s " " -w 01 $REPEAT); do
    cp $track.wav $track-$i.wav
  done
  rm $track.wav

  # Add silence to end of last track
  ffmpeg -i $track-$REPEAT.wav -af "apad=pad_dur=$FADE" out.wav
  mv out.wav $track-$REPEAT.wav

  echo Contacting files
  ffmpeg -y -f concat -safe 0 -i <(for f in ./$track-*.wav; do echo "file '$PWD/$f'"; done) -c copy $track-concat.wav
  ffmpeg -y -i $track-concat.wav $track-concat.m4a
  rm *.wav

  echo Merging with background audio
  ffmpeg -i $track-concat.m4a -i $BG \
    -filter_complex "[0:a][1:a]amix=inputs=2:duration=first:dropout_transition=0[a]" \
    -map "[a]" -c:a aac -shortest merge.m4a
  
  # Make the length of the new file correct
  length=$(ffprobe -i $track-concat.m4a -show_entries format=duration -v quiet -of csv="p=0")
  echo length $length
  ffmpeg -i merge.m4a -t $length -c copy merge-trim.m4a
  cp merge-trim.m4a merge.m4a

  echo Adding fade out
  track_len=$(ffprobe -i merge.m4a -show_entries format=duration -v quiet -of csv="p=0")
  track_len=${track_len%.*}
  fade_start=$(( $track_len-$FADE))

  ffmpeg -i merge.m4a -af "afade=t=out:st=$fade_start:d=$FADE" fade.m4a
  mv fade.m4a $track.m4a
  rm merge.m4a
  rm merge-trim.m4a
  rm *-concat.m4a

  # brew install atomic parsley
  AtomicParsley $track.m4a --artist "${ARTIST}" --album "${ALBUM_TITLE}" --title "$track" --artwork "${ARTWORK}" --year 2023
  mv $track-temp*.m4a $track.m4a
done
